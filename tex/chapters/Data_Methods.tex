\chapter{Data and Methods}\label{sec:data_methods}
{
	This section describes the available data and the challenges associated with it.
	Our study region is a farm of over 800ha, which is located in western Switzerland. From \cite{perichPixelbasedCropYield2022}  we acquired Sentinel-2 (S2) satellite image data (section~\ref{sec:s2_img_data}), yield maps of several cereals from 2017 to 2021 (section~\ref{sec:yieldmapping_data}), and meteorological data (section~\ref{sec:gather_data_to_pixel}). Methods to evaluate an estimator or model are given in section~\ref{sec:general_methods}.
	
	% For {{IM}}s we refer to sections~\ref{sec:itpl_parametric} and~\ref{sec:itpl_nonparametric} for a robust interpolation technique to section~\ref{sec:loess_robustify}. In section~\ref{sec:itpl_param_est} we describe a method to objectively determine the quality of an interpolation, and in chapter~\ref{sec:corr} we present a strategy which involves correction of the NDVI with a weighted interpolation.	
}


\section{Sentinel 2 Data}{
	\label{sec:s2_img_data}
	%\subsection*{General Information}
		The European Space Agency \citep{esaSentinel22022} freely distributes images of the S2 satellites. Together, both satellites have a revisit time of 5 days in our study region.
		The S2 images contain 12 spectral bands with spatial resolutions of up to 10 meters (see table~\ref{table:S2-bands}). Bands with a lower resolution (20 and 60 meters) were upscaled to 10 meter resolution using cubic interpolation \citep{perichPixelbasedCropYield2022}. In order to decrease the effect of atmospheric conditions like reflections and scattering, bottom-of-atmosphere, radiometric corrected Level-2A data was used \citep{esaEuropeanSpaceAgency2022}. %\footnote{According to \cite{perichPixelbasedCropYield2022}: ``Data prior to March 2018 was only available in the top-of-atmosphere L1C format and was downloaded as such [...] L1C data was processed to L2A product level using the `Sen2Cor' processor provided by the European Space Agency''.} 
		\cite{esaEuropeanSpaceAgency2022} also supplies the Scene Classification Layer ({SCL}). It is a model output that for each location assigns the observed pixel to one of 11 SCL-classes (cf. table~\ref{tab:satelite/scl_classes}). 
		\input{tex/chapters/misc/table_S2-bands.tex}
		In this thesis, we will use this classification to filter out data points that we assume to be less informative. These are all observations for which the SCL-class does not correspond to vegetation or bare soils (classes 4 and 5). We define the set SCL45 as the observations that are labelled as SCL-class 4 or 5.
		
		% \begin{figure}[h]
		% 	\label{fig:satelite/sentinel-2-bands}
		% 	\center
		% 	\includegraphics[width=0.4\textwidth]{satelite/sentinel-2-bands.jpg}
		% 	\caption{XXX Sentinel 2 bands.}
		% \end{figure}

		\input{tex/chapters/misc/table_scl_classes.tex}
		

	
}

\section{Crop Yield Data}{
	\label{sec:yieldmapping_data}
	The crop yield data were collected from a combine harvester. Equipped with a satellite-based navigation system, the harvester drives over the fields and continuously estimates the dry crop yield density in $t/ha$ (cf. figure~\ref{fig:satelite/witzwil_2021_P112_yield_harvester_cropped}). 
	We use the data set presented in \cite{perichPixelbasedCropYield2022}, where error-prone measurement points (such as during a tight curve of the combine harvester) were removed and then the yield maps were rasterized using linear interpolation (cf. figure~\ref{fig:satelite/witzwil_2021_P112_yield_cropped.png}). We summarize the rasterized dry yield values by the following statistics:

	% tabelle anstadt histogramm, da schon zu viele figuren `herumschwirren' und es so kompakter ist.
	\begin{tabular}{l l l l l l l} 
		Minimum & 1st Quartile & Median & Mean  & 3rd Quartile & Maximum & Variance \\
		0.107   & 6.186        & 7.560  & 7.359 & 8.756        & 13.35   & 4.035
	\end{tabular}    

	Comparing the average per-field crop yield reported by the farmer with the yield estimated by the combine harvester shows that the latter overestimates crop yield by ca. $10\%$ \citep{perichPixelbasedCropYield2022}. Since the relative estimation error is approximately constant and we do not aim for an absolute yield prediction, we will not consider this deviation. 



	\begin{figure}
		\centering
		\begin{subfigure}{.42\textwidth}
			\centering
			\includegraphics[height=.75\linewidth]{satelite/witzwil_2021_P112_yield_harvester_cropped.png}
			\caption{\small Cleaned combine harvester data}
			\label{fig:satelite/witzwil_2021_P112_yield_harvester_cropped}
		\end{subfigure}%
		\begin{subfigure}{.42\textwidth}
			\centering
			\includegraphics[height=.75\linewidth]{satelite/witzwil_2021_P112_yield_cropped.png}
			\caption{\small Rasterized to Sentinel 2 resolution.}
			\label{fig:satelite/witzwil_2021_P112_yield_cropped.png}
		\end{subfigure}
		\begin{subfigure}{.14\textwidth}
			\centering
			\includegraphics[width=\linewidth]{misc/yield_legend.pdf}
			% \caption{\small Rasterized to Sentinel 2 resolution.}
			% \label{fig:satelite/witzwil_2021_P112_yield_cropped.png}
			\vspace{0.5cm}
		\end{subfigure}
		\vspace{0.2cm}
		\caption[Crop yield density map of a field]{Crop yield density map of a field. }
		\label{fig:satelite_witzwil_yield}
	\end{figure}
}

\section{Normalized Difference Vegetation Index}{% NDVI
	The well-known {NDVI} introduced by \cite{rouseMonitoringVernalAdvancement1974} is used to detect vegetation and to estimate photosynthetic activity in remote sensing \citep{gamonRelationshipsNDVICanopy1995a}. It utilizes the fact that healthy, photosynthesizing vegetation exhibits a large increase in reflectance between the red and infrared region of the light spectrum (cf. appendix figure~\ref{fig:misc/Reflectance-spectra-of-photosynthetic-green-vegetation-non-photosynthetic-dry.png}). It is calculated using the S2 bands `red' and `infrared' (i.e., bands $B4$ and $B8$---cf. table~\ref{table:S2-bands}$B4$) by:
	\begin{equation}
		NDVI = \frac{B8 - B4}{B8 + B4}
		\label{eq:ndvi}
	\end{equation}
	Since we measure the NDVI via the S2 satellites from space, we cannot expect to obtain the same NDVI as measured with a ground-based spectroradiometer. This is especially true if the ground signal is contaminated by either the clouds directly or by cloud shadows. Even if we only use SCL45 observations flagged as cloud-free, we still encounter measurement errors, as illustrated in section~\ref{sec:s2_challangges}. Therefore, we call the calculated values merely the {observed NDVI}. In the following chapters, we will study the resulting NDVI {TS} extensively. Such a {TS} is shown in figure~\ref{fig:raw_ndvi_ts}.
	\begin{figure}[!h]
		\centering
		\begin{subfigure}{.47\textwidth}
			% \centering
			\includegraphics[height=.75\linewidth]{interpol/ndvi_ts_das_grey.pdf}
			\caption{Days After Sowing (DAS)}
			\label{interpol/ndvi_ts_das_grey.pdf}
		\end{subfigure}%
		\hfill
		\begin{subfigure}{.47\textwidth}
			% \centering
			\includegraphics[height=.75\linewidth]{interpol/ndvi_ts_gdd_grey.pdf}
			\caption{Growing Degree Days (GDD)}
			\label{interpol/ndvi_ts_gdd_grey.pdf}
		\end{subfigure}
		\vspace{0.3cm}
		\caption[NDVI {TS} plotted against DAS and GDD]{NDVI {TS} plotted against DAS and GDD. GDD are introduced in section~\ref{sec:gdd_def}.}
		\label{fig:raw_ndvi_ts}
	\end{figure}
}
% \section{DAS vs. GDD}{
% %example plot
% Prior to interpolating the NDVI {TS}, we should decide on a timescale. We can choose between DAS and GDD\todo{Findet man hier noch Literatur, in welcher Ã¤hnliches diskutiert wurde, die man zitieren kann?} (cf. section~\ref{sec:gather_data_to_pixel} and equation~\refeq{eq:gdd}). 
% This has several advantages. First, it makes the scales comparable (in terms of plant growth) because the plants are not concerned with the month of the year but the current temperature. Second, in winter we tend to have higher cloud cover and thus fewer SCL45 observations. 

% \begin{my_figure}[h]{width=0.8\textwidth}{interpol/das_vs_gdd}
% 	\caption{The same NDVI time-series, on the left with DAS as the timescale, on the right GDD is the timescale. SCL45 are colored black. Non-SCL45 (clouds and shadows) are colored in gray.}
% 	\label{fig:interpol/das_vs_gdd}
% \end{my_figure}
\section{Transformation of Timescale}\label{sec:gdd_def}
	{% GDD & DAS
		Two drawbacks become apparent when using Days After Sowing (DAS) as the timescale (see figure~\ref{interpol/ndvi_ts_das_grey.pdf}): First, this scale makes it difficult to compare two NDVI {TS} because wheat is not always sown on the same day of the year and in some years plants begin to emerge earlier. Second, because there are only few SCL45 observations in autumn and winter, we face significant data gaps during this period. To fix both problems, \cite{mcmasterGrowingDegreedaysOne1997} propose to transform the timescale into a meaningful temperature based one. The resulting Growing Degree Days ({GDD}) are defined as the cumulative sum of temperature above a given threshold $T_{base}$ since sowing. For cereals, we use $T_{base}=0$ \citep{holzkamperSpatialTemporalTrends2015}. Thus, the GGD for $n$ days after sowing will be equal to:
		\begin{equation}
			\label{eq:gdd}
			GDD_n := \sum_{i=0}^n \max(T_i - T_{base}, 0).
		\end{equation}

        An example for comparison of the DAS and GDD timescale is shown in figure~\ref{fig:raw_ndvi_ts}. Here we see that the first 120 DAS are compressed to just 500 GDD, and hence the gap in observations was successfully compressed. Given the reasons mentioned above, from now on we will only consider GDD. 
        Important plant growth stages and their corresponding GDD values are tabulated in the appendix~\ref{app:gdd_examples}.
	} 

\section{The Concept of a `Pixel'}{ \label{sec:gather_data_to_pixel}
	Now we create a new data structure that we call Pixel. This originates from the pixels of the S2 satellite images. It will contain all the information needed to answer the research questions in the following chapters. 
		
		Consider a 10 by 10 meter square that coincides with a S2 image pixel and $T$ the GDD values for which S2 images are available in a given season. For $t\in T$ let $P_t$ be a tuple of all the spectral bands, the observed NDVI and the SCL class at the considered location at time $t$. Then, define $P$ as the collection of all the $P_t$ and the estimated dry yield for this square.
		Analogously to $P$, define $P^{SCL45}$ by only considering $P_t$ with SCL-classes 4 or 5 (vegetation and soil).  
}

		% We will call the resulting data set {PIXELS}, as it is the collection of all Pixels (over all seasons). 
		
		% Finally, we split PIXELS randomly into a train ($80\%$) and test  ($20\%$) set. 
\section{Illustration of S2 Images}{\label{sec:s2_challangges}
	\input{tex/chapters/misc/2x3_satelite_ts_plot_grid.tex}
	% Description of plot
	Using an example pixel, we illustrate the challenges in working with S2 image data. Figure~\ref{fig:witzwil_selected_satellite_images} shows a selection of 6 satellite images of a field, and the NDVI {TS} for the highlighted pixel. 
	In February (image a), we see no vegetation but bare soil and thus also a low NDVI. At the beginning of May (b), we observe a cloudless dark green field with a high NDVI. In (c) heavy cloud cover (SCL class 9) leads to a complete loss of plant information in this S2 observation. Figure (d) shows that the SCL classification is not reliable, since we evidently observe clouds, which is also reflected in a sudden NDVI drop. Even though SCL indicates that (e) are thin cirrus clouds, a pale green shimmers through, and we also note a reasonably high NDVI. Therefore, we remark that some SCL45 observations are not accurate and even though a few non-SCL45 observations contain useful information, most of them are too unreliable (e.g., all SCL 9 observations). Thus, we aim to substitute the unreliable ones with interpolated versions and correct contaminated ones.
		
		%% subfigures references:
		% (see.~\ref{fig:satelite/time_series_2021_P112/15_scl5_2021-02-23.png})
		% (see.~\ref{fig:satelite/time_series_2021_P112/30_scl4_2021-05-09.png})
		% (see.~\ref{fig:satelite/time_series_2021_P112/33_scl9_2021-05-24.png})
		% (see.~\ref{fig:satelite/time_series_2021_P112/35_scl4_2021-06-03.png})
		% (see.~\ref{fig:satelite/time_series_2021_P112/40_scl10_2021-06-28.png})
		% (see.~\ref{fig:satelite/time_series_2021_P112/45_scl2_2021-07-23.png})
}

\section{Estimation Evaluation Criteria}{ \label{sec:general_methods}
	In this section, we define score functions to measure estimation accuracy and techniques to adequately apply them. 

	\subsection{Score Functions}\label{sec:scorefun}
	    Now, we define the Root Mean Square Error (RMSE), a prominent and outlier-sensitive score function.
	    \begin{definition}(RMSE)\label{def:rmse}
		Given a vector $y\in \R^n$ and its estimator $\hat y$, we define the RMSE as:
		\begin{equation}
			\label{eq:rmse}
			 \operatorname{RMSE}:=\sqrt{\frac{1}{n}\sum_{i=1}^n (y_i - \hat y_i)^2}
		\end{equation}
		\end{definition}
		Thus, the RMSE measures how close the estimated $\hat y$ are to the original $y$ by considering the squares of errors. The lower the RMSE, the closer are the fitted values to the original values. Note that one strong outlier may corrupt this score function. Therefore, we will also define the $x^\text{th}\%$ Quantile of Absolute Residuals (QAR\textsuperscript{x}) that can handle some fraction of outliers:
		\begin{definition} (QAR\textsuperscript{x}) \label{def:qar}
		    Given a percentage $x\in \{1,2,\dots,100\}$, a vector $y\in \R^n$ and its estimator $\hat y$, assume without loss of generality that $|y_1-\hat y_1|\leq |y_2-\hat y_2|\leq \dots \leq |y_n-\hat y_n|$. Then, we define the QAR\textsuperscript{x} as the biggest residual under the x\% smallest ones. Formally:  
		    \begin{equation}
		        \operatorname{QAR}^{\text{x}}:=\max \left\{|y_i-\hat y_i|:i\leq \frac{x}{100}n \right\}
		    \end{equation}
		\end{definition}
		Note that QAR\textsuperscript{50} coincides with the median of absolute residuals and QAR\textsuperscript{100} with the maximum of absolute residuals. Hence, the higher $x$, the fewer outliers QAR\textsuperscript{x} can handle. Consequently, if we expect the data to have 5\% outliers, we should choose $x$ smaller than 95. Furthermore, if an estimator attains lower QAR\textsuperscript{x} values than a competing estimator for $x=50,75,85$, we conclude\footnote{Strictly speaking, this conclusion assumes that the distribution of the residuals have a similar shape and that they are unimodal (i.e., has only one `peak').} that it also produces smaller residuals in most cases.  
		
	\subsection{Out-Of-Bag and Leave-One-Out-Cross-Validation}{ \label{sec:OOB_LOOCV}
		The rationale for Out-Of-Bag ({OOB}) and Leave-One-Out-Cross-Validation ({LOOCV}) is that we intend to evaluate a model $M$ with unseen data. That is, if $D$ describes the entire dataset, and we train a model on a subset of $D$, we can use the remaining data to evaluate the model. 
		To formally introduce this, let:
		$$
			D=\{(X_{[j,:]},y_j)|\; X\in\R^{n\times p}, y\in \R^n, j=1,\dots,n\}
		$$
		be a dataset, $i\in \{1,\dots,n\}$ and $M^{(-i)}$ a model fitted on a subset of $D\setminus\{(X_{[i,:]},y_i)\}$. Then we call $\hat y_i:= M^{(-i)}(X_{[i,:]})$ an {OOB} estimator of $y_i$. If we do this for all $i\in\{1,\dots,n\}$, we obtain $\hat y := \left(\hat y_1,\dots,\hat y_n\right)$ the OOB estimator for $y\in \R^n$.
		
		In the case that $M^{(-i)}$ was fitted on the set $D\setminus\{(X_i,y_i)\}$ (i.e., not a true subset), we call the corresponding $\hat y_i$ also the LOOCV estimator.	
		If we optimize some parameter via OOB (or LOOCV) this means that we search for the parameter that minimizes some loss function which takes the OOB (or LOOCV) residuals. 
		In the bootstrap (e.g., random forest) framework, we define $\hat y_i$ to be the average of all computed and admissible $M^{(-i)}$. 
	}

}
